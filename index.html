<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SkyOS</title>
<style>
:root{
  --bg-top:#071025;
  --bg-bottom:#0f1720;
  --panel:#0b1220;
  --accent:#2563eb;
  --muted:#9aa4b2;
  --glass: rgba(255,255,255,0.06);
  --win-radius:12px;
  --taskbar-height:56px;
  --font:'Segoe UI', Roboto, system-ui, -apple-system;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:var(--font);color:#e6eef6;overflow:hidden}
#desktop{
  position:relative;width:100%;height:100%;
  background: linear-gradient(180deg,var(--bg-top) 0%, var(--bg-bottom) 100%);
  background-size:cover;background-position:center;
}

/* non-selectable UI except inputs/textareas */
body, .taskbar, .icon, .start-menu, .tile, .window, .win-header, .start-btn, .dock, .footer-note { user-select: none; -webkit-user-select:none; }
input, textarea { user-select: text; -webkit-user-select:text; }
img, .icon > div { -webkit-user-drag:none; pointer-events:none; }

/* layout */
#icons { position:absolute; left:0; top:0; right:0; bottom:0; pointer-events:auto; }
.icon{width:96px;text-align:center;color:var(--muted);cursor:default;position:absolute}
.icon div{font-size:40px;line-height:40px}
.icon span{display:block;margin-top:6px;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.taskbar{position:absolute;left:0;right:0;bottom:0;height:var(--taskbar-height);display:flex;align-items:center;padding:6px 12px;gap:12px;background:rgba(0,0,0,0.35);backdrop-filter:blur(8px);z-index:50}
.task-left{display:flex;align-items:center;gap:10px}
.start-btn{min-width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));display:flex;align-items:center;justify-content:center;cursor:pointer;padding:0 10px;color:var(--muted);font-weight:600}
.start-btn:active{transform:translateY(1px)}
.search-box{min-width:320px;padding:8px 12px;border-radius:12px;background:var(--glass);display:flex;align-items:center;gap:8px}
.search-box input{background:transparent;border:none;outline:none;color:var(--muted);width:100%}
.task-right{margin-left:auto;display:flex;align-items:center;gap:10px}
.clock{padding:6px 10px;border-radius:8px;background:transparent;color:var(--muted);font-size:13px}
.start-menu{position:absolute;left:12px;bottom:70px;width:560px;background:rgba(0,0,0,0.45);border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6);display:none;z-index:60}
.start-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
.tile{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tile .emoji{font-size:22px;margin-bottom:6px}
.dock{display:flex;gap:8px;align-items:center}
.window{
  position:absolute;width:760px;height:480px;background:var(--panel);border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.6);overflow:hidden;display:flex;flex-direction:column;min-width:320px;min-height:160px
}
.win-header{height:44px;display:flex;align-items:center;padding:8px 12px;gap:8px;background:#0f1a2a;cursor:grab;flex-shrink:0}
.win-title{flex:1;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.win-controls{display:flex;gap:8px}
.win-controls button{width:34px;height:30px;border-radius:8px;border:none;background:transparent;color:var(--muted);cursor:pointer}
.win-body{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px}
.hidden{display:none}
.minimized{transform:translateY(200px);opacity:0.2}

/* Terminal */
.terminal{background:#071219;color:#9ef08a;font-family:monospace;padding:6px;border-radius:8px;height:100%;display:flex;flex-direction:column}
.terminal-output{flex:1;overflow:auto;padding:8px;display:block}
.terminal-line{white-space:pre-wrap;margin:4px 0}
.terminal-input{display:flex;gap:8px;align-items:center;padding-top:6px;border-top:1px solid rgba(255,255,255,0.02)}
.terminal-input input{flex:1;background:transparent;border:none;padding:8px;color:#dfffdc;outline:none;font-family:monospace}

/* Explorer/others */
.explorer .file{padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);margin-bottom:8px;display:flex;align-items:center;gap:10px}
.settings .row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.02)}
.right-pane{width:320px;padding-left:12px}
.split{display:flex;height:100%}
.resizer{width:6px;cursor:col-resize;background:transparent}
.toast{position:absolute;right:18px;bottom:80px;background:rgba(0,0,0,0.6);padding:10px;border-radius:8px;z-index:70}
.btn{padding:8px 10px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer}
.footer-note{position:absolute;left:12px;bottom:calc(var(--taskbar-height) + 18px);color:var(--muted);font-size:12px}
.win-body *{max-width:100%;box-sizing:border-box}

/* context menu */
.ctx-menu {
  position:fixed;
  background:rgba(10,12,18,0.98);
  color:var(--muted);
  border-radius:8px;
  box-shadow:0 10px 30px rgba(0,0,0,0.6);
  padding:6px;
  z-index:999999;
  min-width:160px;
  font-size:14px;
}
.ctx-item {
  display:flex;align-items:center;gap:8px;padding:8px;border-radius:6px;cursor:pointer;
}
.ctx-item:hover { background: rgba(255,255,255,0.02); color: #e6eef6; }
.ctx-emoji { font-size:16px; width:20px; text-align:center; }
</style>
</head>
<body>
<div id="desktop" tabindex="0">
  <div id="icons" aria-hidden="false"></div>
  <div id="windows" aria-live="polite"></div>

  <div id="startMenu" class="start-menu" role="menu" aria-hidden="true">
    <div style="display:flex;gap:12px;align-items:flex-start">
      <div style="flex:1">
        <div style="font-weight:700;margin-bottom:8px">Pinned</div>
        <div class="start-grid" id="pinnedGrid"></div>
      </div>
      <div style="width:320px">
        <div style="font-weight:700;margin-bottom:8px">Recommended</div>
        <div id="recommended"></div>
      </div>
    </div>
  </div>

  <div class="taskbar" role="toolbar" aria-label="Taskbar">
    <div class="task-left">
      <div class="start-btn" id="startBtn" title="Sky" aria-expanded="false">Sky</div>
      <div class="search-box" title="Search">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="6"/><path d="M21 21l-4.35-4.35"/></svg>
        <input id="searchInput" placeholder="Type here to search..." />
      </div>
      <div class="dock" id="dock" aria-hidden="false"></div>
    </div>
    <div class="task-right">
      <div class="clock" id="clock"></div>
    </div>
  </div>

  <div class="footer-note">SkyOS</div>
</div>

<script>
/* ---------------- state ---------------- */
const STATE_KEY = 'skyos_state_v1';
let state = JSON.parse(localStorage.getItem(STATE_KEY) || '{}');
if(!state.files) state.files = { 'welcome.txt': 'Welcome to SkyOS!\\nDouble-click icons or open Start (Sky).' };
if(!state.apps) state.apps = {}; 
if(!state.pinned) state.pinned = ['explorer','terminal','settings','notes','calculator','store']; 
saveState();
function saveState(){ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }

/* ---------------- APPS registry (easy to add apps) ----------------
   Add apps here with: id, name, emoji, description, content (HTML string)
   content can be HTML or you can have the app open a custom function.
*/
const APPS = {
  explorer: {
    id: 'explorer',
    name: 'File Explorer',
    emoji: 'ðŸ“',
    desc: 'Browse and open files',
    content: null // created dynamically in openExplorer()
  },
  terminal: {
    id: 'terminal',
    name: 'Terminal',
    emoji: 'âŒ˜',
    desc: 'Command line terminal',
    content: null // created dynamically
  },
  settings: {
    id: 'settings',
    name: 'Settings',
    emoji: 'âš™ï¸',
    desc: 'System settings',
    content: null
  },
  notes: {
    id: 'notes',
    name: 'Notes',
    emoji: 'ðŸ“',
    desc: 'Simple notes editor',
    content: null
  },
  calculator: {
    id: 'calculator',
    name: 'Calculator',
    emoji: 'ðŸ§®',
    desc: 'Basic calculator',
    content: null
  },
  wallpaper: {
    id: 'wallpaper',
    name: 'Wallpapers',
    emoji: 'ðŸ–¼ï¸',
    desc: 'Set desktop wallpaper',
    content: null
  },
  store: {
    id: 'store',
    name: 'Store',
    emoji: 'ðŸ›’',
    desc: 'Get apps and pin them',
    content: null
  }
};

/* ---------------- globals / DOM roots ---------------- */
const iconsRoot = document.getElementById('icons');
const windowsRoot = document.getElementById('windows');
const dock = document.getElementById('dock');
const startBtn = document.getElementById('startBtn');
const startMenu = document.getElementById('startMenu');
let zIndex = 10;

/* desktop icon positions (modifiable) */
let desktopIcons = [
  {id:'explorer', x:30, y:40},
  {id:'terminal', x:30, y:140},
  {id:'settings', x:30, y:240},
  {id:'notes', x:30, y:340},
  {id:'calculator', x:30, y:440},
  {id:'store', x:30, y:540}
];

/* internal clipboard for Copy/Cut/Paste operations (app id) */
let internalClipboard = null;
let internalCut = false;

/* Utility: prettify id to name */
function prettify(id){
  return (APPS[id] && APPS[id].name) ? APPS[id].name : id.split(/[-_]/).map(s=>s[0].toUpperCase()+s.slice(1)).join(' ');
}

/* ---------------- render desktop icons ---------------- */
function renderIcons(){
  iconsRoot.innerHTML = '';
  desktopIcons.forEach((ic, idx)=>{
    const app = APPS[ic.id] || {emoji:'â€¢', name:ic.id};
    const el = document.createElement('div');
    el.className = 'icon';
    el.style.left = ic.x + 'px';
    el.style.top  = ic.y + 'px';
    el.dataset.index = idx;
    el.dataset.appid = ic.id;
    el.innerHTML = `<div>${app.emoji}</div><span>${app.name}</span>`;
    el.ondblclick = ()=>openApp(ic.id);
    // right-click on icon -> show app context menu
    el.addEventListener('contextmenu', (ev)=>{
      ev.preventDefault();
      showContextMenu(ev.clientX, ev.clientY, {type:'icon', index:idx, appId:ic.id});
    });
    // allow dragging icons with Ctrl+drag (simple)
    let dragIcon = null;
    el.addEventListener('mousedown', (e)=>{
      if(e.ctrlKey){
        dragIcon = {el, startX:e.clientX, startY:e.clientY, origX:ic.x, origY:ic.y};
        document.addEventListener('mousemove', iconMove);
        document.addEventListener('mouseup', iconUp, {once:true});
      }
    });
    function iconMove(ev){
      if(!dragIcon) return;
      const dx = ev.clientX - dragIcon.startX;
      const dy = ev.clientY - dragIcon.startY;
      const newX = Math.max(0, dragIcon.origX + dx);
      const newY = Math.max(0, dragIcon.origY + dy);
      ic.x = newX; ic.y = newY;
      el.style.left = newX + 'px'; el.style.top = newY + 'px';
    }
    function iconUp(){ dragIcon = null; document.removeEventListener('mousemove', iconMove); saveState(); }
    iconsRoot.appendChild(el);
  });
}

/* ---------------- Start menu & pinned icons (emoji tiles) ---------------- */
startBtn.addEventListener('click', (e)=>{ e.stopPropagation(); const open = startMenu.style.display !== 'block'; startMenu.style.display = open ? 'block' : 'none'; startBtn.setAttribute('aria-expanded', open); renderStartMenu(); });
document.addEventListener('click', (e)=>{ if(!startMenu.contains(e.target) && !startBtn.contains(e.target)) startMenu.style.display='none'; });

function renderStartMenu(){
  const pinnedGrid = document.getElementById('pinnedGrid');
  pinnedGrid.innerHTML = '';
  const pinned = state.pinned && state.pinned.length ? state.pinned : Object.keys(APPS);
  pinned.forEach(id=>{
    const app = APPS[id] || {emoji:'â€¢', name:id};
    const t = document.createElement('div'); t.className='tile';
    t.innerHTML = `<div class="emoji">${app.emoji}</div><div style="font-size:12px">${app.name}</div>`;
    t.title = app.name;
    t.onclick = ()=>{ openApp(id); startMenu.style.display='none'; };
    pinnedGrid.appendChild(t);
  });
  document.getElementById('recommended').innerHTML = `<div style="color:var(--muted)">Recommended: none</div>`;
}

/* ---------------- dock (taskbar icons) ---------------- */
function renderDock(){
  dock.innerHTML = '';
  const dockItems = ['explorer','terminal','settings','store'];
  dockItems.forEach(id=>{
    const app = APPS[id] || {emoji:id[0].toUpperCase(), name:id};
    const b = document.createElement('div');
    b.className = 'start-btn';
    b.style.minWidth = '40px';
    b.textContent = app.emoji || app.name.charAt(0);
    b.title = app.name;
    b.onclick = ()=>openApp(id);
    b.addEventListener('contextmenu',(ev)=>{ ev.preventDefault(); showContextMenu(ev.clientX, ev.clientY, {type:'dock', appId:id}); });
    dock.appendChild(b);
  });
}
renderDock();

/* ---------------- window manager ---------------- */
function createWindow(opts){
  const win = document.createElement('div'); 
  win.className='window';
  win.style.left = (opts.x||80)+'px'; 
  win.style.top = (opts.y||80)+'px';
  win.style.width = (opts.width||720)+'px'; 
  win.style.height = (opts.height||460)+'px';
  win.style.zIndex = ++zIndex;
  win.dataset.app = opts.app || 'app';
  win.dataset.max = '0';

  const header = document.createElement('div'); header.className='win-header';
  const title = document.createElement('div'); title.className='win-title';
  title.textContent = opts.title || prettify(opts.app||'App');
  const controls = document.createElement('div'); controls.className='win-controls';

  const btnMin = document.createElement('button'); btnMin.textContent='â€”';
  const btnMax = document.createElement('button'); btnMax.textContent='â–¡';
  const btnClose = document.createElement('button'); btnClose.textContent='âœ•';

  controls.append(btnMin,btnMax,btnClose);
  header.append(title,controls);

  const body = document.createElement('div'); 
  body.className='win-body';
  if(opts.content instanceof Node) body.appendChild(opts.content);
  else body.innerHTML = opts.content || '';
  win.append(header,body);
  windowsRoot.appendChild(win);

  header.addEventListener('mousedown', (e)=>{ e.preventDefault(); bringToFront(win); startDrag(win,e); });
  header.addEventListener('dblclick', ()=>toggleMax(win));
  win.addEventListener('mousedown', ()=>bringToFront(win));

  btnClose.onclick = ()=>win.remove();

  /* minimize fix: if minimized from maximized, clear max flag so icons remain shown */
  btnMin.onclick = ()=>{
      if (win.dataset.max === '1') {
          win.dataset.max = '0';
      }
      win.classList.add('hidden');
      createTaskbarEntry(win);

      // re-check if any other windows are maximized; only hide icons if another is maximized
      const stillMax = Array.from(document.querySelectorAll('.window'))
          .some(w => w.dataset.max === '1');
      iconsRoot.style.visibility = stillMax ? 'hidden' : 'visible';
  };

  btnMax.onclick = ()=>toggleMax(win);

  return win;
}

function bringToFront(win){ win.style.zIndex = ++zIndex; }

let drag = null;
function startDrag(win,e){
  bringToFront(win);
  drag = {win, ox:e.clientX, oy:e.clientY, lx: win.offsetLeft, ly: win.offsetTop};
  document.body.style.userSelect='none';
}
window.addEventListener('mousemove', (e)=>{
  if(!drag) return;
  const nx = drag.lx + (e.clientX - drag.ox);
  const ny = drag.ly + (e.clientY - drag.oy);
  const maxX = window.innerWidth - Math.min(100, drag.win.offsetWidth);
  const maxY = window.innerHeight - Math.min(100, drag.win.offsetHeight) - 
               parseInt(getComputedStyle(document.documentElement).getPropertyValue('--taskbar-height'));
  drag.win.style.left = Math.max(0, Math.min(nx, maxX)) + 'px';
  drag.win.style.top  = Math.max(0, Math.min(ny, maxY)) + 'px';
});
window.addEventListener('mouseup', ()=>{ drag = null; document.body.style.userSelect='auto'; });

function toggleMax(win){
  if(win.dataset.max === '1'){
    try{
      const prev = JSON.parse(win.dataset.prevPos || '{}');
      win.style.position = prev.position || 'absolute';
      win.style.left = prev.left || '80px';
      win.style.top = prev.top || '80px';
      win.style.width = prev.width || '720px';
      win.style.height = prev.height || '460px';
    }catch(e){}
    win.dataset.max='0';
  } else {
    win.dataset.prevPos = JSON.stringify({ left: win.style.left, top: win.style.top, width: win.style.width, height: win.style.height, position: win.style.position||'absolute' });
    win.style.position = 'fixed';
    win.style.left = '0px'; win.style.top = '0px'; win.style.width = '100%'; win.style.height = `calc(100% - var(--taskbar-height))`;
    win.dataset.max='1';
  }
  /* NOTE: removed auto-hiding of icons on maximize â€” icons should NOT disappear when fullscreen */
  // previous code hid icons; we intentionally do NOT change iconsRoot visibility here
}

/* create minimize entry in dock */
function createTaskbarEntry(win){
  const el = document.createElement('div'); 
  el.className='start-btn';
  const appId = win.dataset.app;
  el.textContent = (APPS[appId] && APPS[appId].emoji) ? APPS[appId].emoji : prettify(appId).charAt(0);
  el.title = prettify(appId);
  el.onclick = ()=>{ win.classList.remove('hidden'); windowsRoot.appendChild(win); bringToFront(win); el.remove(); };
  dock.appendChild(el);
}

/* ---------------- apps ---------------- */
function openApp(id){
  if(id==='terminal') openTerminal();
  else if(id==='explorer') openExplorer();
  else if(id==='settings') openSettings();
  else if(id==='notes') openNotes();
  else if(id==='calculator') openCalculator();
  else if(id==='wallpaper') openWallpaperPicker();
  else if(id==='store') openStore();
  else createWindow({title:prettify(id), app:id, content:`<div style="padding:12px">App ${id} - placeholder</div>`});
}

/* ---- Terminal ---- */
function openTerminal(){
  const term=document.createElement('div'); term.className='terminal';
  const out=document.createElement('div'); out.className='terminal-output';
  const inputRow=document.createElement('div'); inputRow.className='terminal-input';
  const prompt=document.createElement('div'); prompt.style.opacity='0.9'; prompt.textContent='$';
  const input=document.createElement('input'); input.placeholder='Type command (help)'; input.autofocus=true;

  inputRow.appendChild(prompt); inputRow.appendChild(input); 
  term.appendChild(out); term.appendChild(inputRow);
  const win=createWindow({title:'Terminal', app:'terminal', content:''});
  win.querySelector('.win-body').appendChild(term);

  function print(t){
    const line=document.createElement('div'); 
    line.className='terminal-line';
    line.innerHTML=t.replace(/\n/g,'<br>');
    out.appendChild(line); 
    out.scrollTop = out.scrollHeight;
  }

  print('Welcome to SkyOS Terminal â€” type help');

  input.addEventListener('keydown',(e)=>{
    if(e.key==='Enter'){
      const cmd=input.value.trim();
      if(!cmd) return;
      print(`<div style="color:#9bd3ff">$ ${escapeHtml(cmd)}</div>`);
      handleCmd(cmd,print,out);
      input.value='';
    }
  });
}

function handleCmd(cmd, print, outEl){
  const parts = cmd.split(/\s+/); 
  const c = parts[0]; 
  const args = parts.slice(1);

  if(c==='help') print('Commands: help, clear, ls, cat [file], date, time, echo [text], touch [name]');
  else if(c==='clear') outEl.innerHTML = '';
  else if(c==='ls') print(Object.keys(state.files).join('  '));
  else if(c==='cat'){
    const f=args[0]; 
    if(!f) print('Usage: cat filename'); 
    else print(state.files[f] || ('No such file: '+f));
  }
  else if(c==='date') print(new Date().toDateString());
  else if(c==='time') print(new Date().toLocaleTimeString());
  else if(c==='echo') print(args.join(' '));
  else if(c==='touch'){
    const name=args[0]; 
    if(!name) print('Usage: touch filename'); 
    else { state.files[name]=''; saveState(); print('Created '+name); }
  }
  else print('Unknown command: '+c);
}

/* ---- Explorer ---- */
function openExplorer(){
  const filesHtml = Object.keys(state.files).map(k=>{
    const preview = String(state.files[k]||'').slice(0,120).replace(/</g,'&lt;');
    return `<div class="file"><div style="font-size:20px">ðŸ“„</div><div style="flex:1"><strong>${k}</strong><div style="color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${preview}</div></div><div><button class="btn open">Open</button></div></div>`;
  }).join('');

  const content = document.createElement('div'); 
  content.className='split';
  const left = document.createElement('div'); left.style.flex='1'; left.className='explorer'; left.innerHTML = filesHtml;
  const res = document.createElement('div'); res.className='resizer';
  const right = document.createElement('div'); right.className='right-pane'; right.innerHTML = `<div style="font-weight:700;margin-bottom:8px">Details</div><div id="fileDetails" style="color:var(--muted)">Select a file</div>`;
  content.appendChild(left); content.appendChild(res); content.appendChild(right);
  const win = createWindow({title:'File Explorer', app:'explorer', content:content});
  win.querySelectorAll('.open').forEach((b,i)=>{ b.onclick = ()=>{ const fname = Object.keys(state.files)[i]; openNoteWindow(fname); }; });
}

/* ---- Notes ---- */
function openNoteWindow(fname){
  const content = document.createElement('div');
  content.style.display='flex'; content.style.flexDirection='column'; content.style.height='100%';
  const ta = document.createElement('textarea');
  ta.style.flex='1'; ta.style.background='transparent'; ta.style.border='none'; ta.style.color='var(--muted)'; ta.style.outline='none'; ta.style.padding='12px';
  ta.value = state.files[fname] || '';
  const row = document.createElement('div'); row.style.textAlign='right'; row.style.marginTop='8px';
  const saveBtn = document.createElement('button'); saveBtn.className='btn save'; saveBtn.textContent='Save';
  row.appendChild(saveBtn); content.appendChild(ta); content.appendChild(row);
  const win = createWindow({title:fname, app:'notes', content:content});
  saveBtn.onclick = ()=>{ state.files[fname] = ta.value; saveState(); showToast('Saved '+fname); };
}
function openNotes(){ const fname = 'note-'+Date.now()+'.txt'; state.files[fname] = state.files[fname] || ''; saveState(); openNoteWindow(fname); }

/* ---- Settings ---- */
function openSettings(){
  const content = document.createElement('div'); content.className='settings';
  content.innerHTML = `<div class="row"><div>Theme</div><div><button class="btn" id="themeToggle">Toggle UI Theme</button></div></div><div class="row"><div>Reset</div><div><button id="resetBtn" class="btn">Reset</button></div></div>`;
  const win = createWindow({title:'Settings', app:'settings', content:content});
  win.querySelector('#themeToggle').onclick = ()=>{ document.body.classList.toggle('light'); showToast('Toggled theme'); };
  win.querySelector('#resetBtn').onclick = ()=>{ if(confirm('Reset state?')){ localStorage.removeItem(STATE_KEY); location.reload(); } };
}

/* ---- Calculator ---- */
function openCalculator(){
  const content = document.createElement('div'); content.style.display='flex'; content.style.flexDirection='column'; content.style.height='100%';
  const inp = document.createElement('input'); inp.style.fontSize='20px'; inp.style.padding='10px'; inp.style.borderRadius='8px'; inp.style.border='none'; inp.style.background='rgba(255,255,255,0.02)'; inp.style.color='var(--muted)'; inp.placeholder='12*3+4';
  const row = document.createElement('div'); row.style.textAlign='right'; row.style.marginTop='8px';
  const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Calculate'; row.appendChild(btn);
  const out = document.createElement('div'); out.style.marginTop='12px'; out.style.color='var(--muted)';
  content.appendChild(inp); content.appendChild(row); content.appendChild(out);
  const win = createWindow({title:'Calculator', app:'calculator', content:content});
  btn.onclick = ()=>{ try{ const res = Function('return ('+inp.value+')')(); out.textContent = String(res); } catch(e){ out.textContent = 'Error'; } };
}

/* ---- Wallpaper picker ---- */
function openWallpaperPicker(){
  const content = document.createElement('div'); content.style.padding='8px';
  const input = document.createElement('input'); input.placeholder='Paste image URL here (optional)'; input.style.width='100%'; input.style.marginBottom='8px';
  const setBtn = document.createElement('button'); setBtn.className='btn'; setBtn.textContent='Set Wallpaper';
  const resetBtn = document.createElement('button'); resetBtn.className='btn'; resetBtn.style.marginLeft='8px'; resetBtn.textContent='Reset to Default (gradient)';
  content.appendChild(input); content.appendChild(setBtn); content.appendChild(resetBtn);
  const win = createWindow({title:'Wallpaper', app:'wallpaper', content:content});
  setBtn.onclick = ()=>{ const url = input.value.trim(); if(url){ state.wallpaper = url; saveState(); applyWallpaper(); showToast('Wallpaper set'); } };
  resetBtn.onclick = ()=>{ state.wallpaper = ''; saveState(); applyWallpaper(); showToast('Wallpaper reset'); };
}
function applyWallpaper(){ if(state.wallpaper && state.wallpaper.length) document.getElementById('desktop').style.backgroundImage = `url('${state.wallpaper}')`; else document.getElementById('desktop').style.backgroundImage = ''; }
applyWallpaper();

/* ---- Store app ---- */
const STORE_APPS = [
  {id:'notes', name:'Notes', emoji:'ðŸ“', desc:'Simple notes editor'},
  {id:'calculator', name:'Calculator', emoji:'ðŸ§®', desc:'Basic calculator'},
  {id:'wallpaper', name:'Wallpapers', emoji:'ðŸ–¼ï¸', desc:'Set a desktop wallpaper'}
];
function openStore(){
  const content = document.createElement('div'); content.style.display='flex'; content.style.flexDirection='column'; content.style.gap='8px';
  const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(2,1fr)'; grid.style.gap='8px';
  STORE_APPS.forEach(a=>{
    const card = document.createElement('div'); card.style.padding='10px'; card.style.borderRadius='8px'; card.style.background='rgba(255,255,255,0.02)';
    card.innerHTML = `<div style="font-size:22px">${a.emoji}</div><div style="font-weight:700">${a.name}</div><div style="color:var(--muted);font-size:13px">${a.desc}</div>`;
    const install = document.createElement('button'); install.className='btn'; install.textContent = 'Install'; install.style.marginTop='8px';
    install.onclick = ()=>{ if(!state.pinned.includes(a.id)) state.pinned.push(a.id); state.apps[a.id] = true; saveState(); renderStartMenu(); showToast(a.name+' installed and pinned'); };
    card.appendChild(install); grid.appendChild(card);
  });
  content.appendChild(grid);
  const win = createWindow({title:'Store', app:'store', content:content});
}

/* ---------------- utilities ---------------- */
function showToast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),1500); }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* keyboard shortcuts */
window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='t'){ e.preventDefault(); openTerminal(); } if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='e'){ e.preventDefault(); openExplorer(); } });

/* double-click desktop â†’ new note */
document.getElementById('desktop').addEventListener('dblclick',(e)=>{ if(e.target.id === 'desktop') openNotes(); });

/* disable dragging of images */
document.addEventListener('mousedown',(e)=>{ const tag = e.target.tagName.toLowerCase(); if(tag==='img') e.preventDefault(); });

/* ---------------- Context menu implementation ----------------
   showContextMenu(x,y, meta) where meta: { type: 'desktop'|'icon'|'dock', index?, appId? }
*/
function removeContextMenus(){ document.querySelectorAll('.ctx-menu').forEach(m=>m.remove()); }
document.addEventListener('click', ()=>removeContextMenus());
document.addEventListener('contextmenu', (ev)=>{ // global: show desktop menu when right-clicking background
  const isOnIcon = ev.target.closest('.icon');
  if(isOnIcon) return; // let icon handler manage it
  ev.preventDefault();
  showContextMenu(ev.clientX, ev.clientY, {type:'desktop'});
});

function showContextMenu(x,y, meta){
  removeContextMenus();
  const menu = document.createElement('div'); menu.className='ctx-menu';
  // items array: {emoji, label, fn, showIf}
  const items = [];
  // For desktop background: show Paste (if clipboard), New Note
  if(meta.type === 'desktop'){
    items.push({e:'ðŸ“¥', t:'Paste', fn: ()=>{ if(internalClipboard){ pasteIconAt(internalClipboard, x, y); } }, show: ()=>!!internalClipboard});
    items.push({e:'ðŸ“', t:'New Note', fn: ()=>{ openNotes(); }});
  }
  // For dock/app icon: generic open
  if(meta.type === 'dock'){
    items.push({e:'ðŸ”“', t:'Open', fn: ()=>{ openApp(meta.appId); }});
  }
  // For icon: copy, cut, paste, delete, pin/unpin
  if(meta.type === 'icon'){
    items.push({e:'ðŸ“‹', t:'Copy', fn: ()=>{ internalClipboard = meta.appId; internalCut = false; showToast('Copied'); }});
    items.push({e:'âœ‚ï¸', t:'Cut', fn: ()=>{ internalClipboard = meta.appId; internalCut = true; showToast('Cut'); }});
    items.push({e:'ðŸ“¥', t:'Paste', fn: ()=>{ if(internalClipboard){ pasteIconAt(internalClipboard, x, y); if(internalCut){ // remove original icon if cut
        removeIconByIndex(meta.index); internalCut = false; internalClipboard = null;
      } } }, show: ()=>!!internalClipboard});
    items.push({e:'ðŸ—‘ï¸', t:'Delete', fn: ()=>{ removeIconByIndex(meta.index); }, show: ()=>true});
    const pinned = state.pinned || [];
    const pinnedAlready = pinned.includes(meta.appId);
    items.push({e:pinnedAlready ? 'ðŸ“' : 'ðŸ“Œ', t: pinnedAlready ? 'Unpin' : 'Pin', fn: ()=>{ if(pinnedAlready){ state.pinned = pinned.filter(id=>id!==meta.appId); showToast('Unpinned'); } else { state.pinned.push(meta.appId); showToast('Pinned'); } saveState(); renderStartMenu(); }, show: ()=>true});
  }

  // Build DOM for visible items
  items.filter(it => it.show === undefined ? true : it.show()).forEach(it=>{
    const row = document.createElement('div'); row.className='ctx-item';
    row.innerHTML = `<div class="ctx-emoji">${it.e}</div><div>${it.t}</div>`;
    row.addEventListener('click', (ev)=>{ ev.stopPropagation(); try{ it.fn(); } catch(e){ console.error(e); } removeContextMenus(); });
    menu.appendChild(row);
  });

  document.body.appendChild(menu);
  // position with viewport clamping
  const rect = menu.getBoundingClientRect();
  let left = x; let top = y;
  if(left + rect.width > window.innerWidth) left = window.innerWidth - rect.width - 8;
  if(top + rect.height > window.innerHeight) top = window.innerHeight - rect.height - 8;
  menu.style.left = left + 'px'; menu.style.top = top + 'px';
}

/* paste icon at coords */
function pasteIconAt(appId, clientX, clientY){
  // convert client coords to desktop local coords
  const desktopRect = document.getElementById('desktop').getBoundingClientRect();
  const x = Math.max(8, Math.min(desktopRect.width - 80, clientX - desktopRect.left));
  const y = Math.max(8, Math.min(desktopRect.height - 40, clientY - desktopRect.top));
  desktopIcons.push({id:appId, x: Math.round(x), y: Math.round(y)});
  renderIcons();
  saveState();
}

/* remove icon by index */
function removeIconByIndex(index){
  if(index>=0 && index < desktopIcons.length){
    const removed = desktopIcons.splice(index,1);
    renderIcons();
    saveState();
    showToast('Deleted ' + (removed[0] && (APPS[removed[0].id] ? APPS[removed[0].id].name : removed[0].id)));
  }
}

/* ---------------- final setup & init ---------------- */
state.files['welcome.txt'] = state.files['welcome.txt'] || 'Welcome to SkyOS â€” double-click icons to open apps. Use Sky to open Start.';
saveState();
renderStartMenu();
renderIcons();
renderDock();

/* prevent default context menu on icons (we handle right click) */
document.addEventListener('contextmenu', (ev)=>{
  if(ev.target.closest('.icon')) ev.preventDefault();
});
</script>
</body>
</html>
